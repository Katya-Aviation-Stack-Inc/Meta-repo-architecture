name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        technology: [
          "air-to-air-mesh",
          "neuro-fcc",
          "self-adaptive-rotor-blades",
          "cold-jet",
          "local-gravity-field-navigation",
          "predictive-airflow-engine",
          "self-healing-avionics-bios",
          "vortex-shield",
          "air-swarm-os",
          "star-nav-core"
        ]
        compiler: [gcc, clang]
        build_type: [Debug, Release]

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libpthread-stubs0-dev

    - name: Configure CMake
      working-directory: ${{ matrix.technology }}
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_CXX_COMPILER=${{ matrix.compiler }}++

    - name: Build
      working-directory: ${{ matrix.technology }}/build
      run: make -j$(nproc)

    - name: Run tests
      working-directory: ${{ matrix.technology }}/build
      run: |
        if [ -f "Makefile" ] && grep -q "test" Makefile; then
          make test
        else
          echo "No tests found for ${{ matrix.technology }}"
        fi

    - name: Run demo
      working-directory: ${{ matrix.technology }}/build
      run: |
        if [ -f "*_demo" ]; then
          timeout 30s ./*_demo || true
        else
          echo "No demo found for ${{ matrix.technology }}"
        fi

  performance-test:
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        technology: [
          "neuro-fcc",
          "vortex-shield",
          "predictive-airflow-engine",
          "air-swarm-os",
          "star-nav-core"
        ]

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libpthread-stubs0-dev

    - name: Build for performance testing
      working-directory: ${{ matrix.technology }}
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++ -DCMAKE_CXX_FLAGS="-O3 -march=native"
        make -j$(nproc)

    - name: Run performance benchmarks
      working-directory: ${{ matrix.technology }}/build
      run: |
        if [ -f "*_demo" ]; then
          timeout 60s ./*_demo --benchmark || true
        else
          echo "No demo found for performance testing"
        fi

  code-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        technology: [
          "air-to-air-mesh",
          "neuro-fcc",
          "self-adaptive-rotor-blades",
          "cold-jet",
          "local-gravity-field-navigation",
          "predictive-airflow-engine",
          "self-healing-avionics-bios",
          "vortex-shield",
          "air-swarm-os",
          "star-nav-core"
        ]

    steps:
    - uses: actions/checkout@v3

    - name: Install clang-tidy
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy

    - name: Run clang-tidy
      working-directory: ${{ matrix.technology }}/src
      run: |
        find . -name "*.cpp" -o -name "*.c" | xargs clang-tidy --warnings-as-errors='*' -checks='-*,modernize-*,performance-*,readability-*,bugprone-*' || true

  memory-check:
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        technology: [
          "neuro-fcc",
          "vortex-shield",
          "predictive-airflow-engine"
        ]

    steps:
    - uses: actions/checkout@v3

    - name: Install valgrind
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libpthread-stubs0-dev valgrind

    - name: Build with debug symbols
      working-directory: ${{ matrix.technology }}
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_COMPILER=g++ -DCMAKE_CXX_FLAGS="-g -O0"
        make -j$(nproc)

    - name: Run valgrind
      working-directory: ${{ matrix.technology }}/build
      run: |
        if [ -f "*_demo" ]; then
          timeout 120s valgrind --leak-check=full --error-exitcode=1 ./*_demo || true
        else
          echo "No demo found for memory checking"
        fi

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install documentation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz

    - name: Generate documentation
      run: |
        if [ -f "Doxyfile" ]; then
          doxygen Doxyfile
        else
          echo "No Doxyfile found"
        fi

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: documentation
        path: docs/html/
